name: CI Pipeline

on:
  pull_request:
    types: [opened, synchronize]
  push:
  workflow_dispatch:

jobs:
  # PRãŒä½œæˆãƒ»æ›´æ–°ã•ã‚ŒãŸæ™‚ã«Bedrockã§ã‚³ãƒ¼ãƒ‰ãƒ¬ãƒ“ãƒ¥ãƒ¼
  pr-review:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
      contents: read
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get optimized diff
        uses: actions/github-script@v7
        id: get-diff
        with:
          script: |
            const files = await github.rest.pulls.listFiles({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number
            });

            // ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
            const targetFiles = files.data.filter(file => {
              // å¤‰æ›´ãŒå¤§ãã™ããªã„ã‚‚ã®
              const isReasonableSize = file.changes < 1000;
              // ãƒ‘ãƒƒãƒãŒå­˜åœ¨ã™ã‚‹ï¼ˆãƒ†ã‚­ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ï¼‰
              const hasPatch = file.patch !== undefined;

              return isReasonableSize && hasPatch;
            });

            // æœ€å¤§10ãƒ•ã‚¡ã‚¤ãƒ«ã¾ã§
            const diffData = targetFiles.slice(0, 10);

            // äººé–“ãŒèª­ã‚ã‚‹å½¢å¼ã«æ•´å½¢
            const formattedContent = diffData.map(file =>
              `ãƒ•ã‚¡ã‚¤ãƒ«: ${file.filename}\\nå¤‰æ›´å†…å®¹:\\n${file.patch}\\n---`
            ).join('\\n\\n');

            return formattedContent;

      - name: Call API with filtered data
        id: api-call
        env:
          DIFF_CONTENT: ${{ steps.get-diff.outputs.result }}
          API_ENDPOINT: ${{ secrets.API_ENDPOINT }}
        run: |
          # API ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã®æ¤œè¨¼
          if [ -z "$API_ENDPOINT" ]; then
            echo "Error: API_ENDPOINT secret is not set" >&2
            echo "Please configure the API_ENDPOINT secret in your repository settings" >&2
            exit 1
          fi

          # DIFFã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã®æ¤œè¨¼
          if [ -z "$DIFF_CONTENT" ]; then
            echo "Warning: No diff content found. Sending empty content." >&2
            DIFF_CONTENT="No changes detected"
          fi

          # æ•´å½¢æ¸ˆã¿ãƒ†ã‚­ã‚¹ãƒˆã‚’contentãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«ã‚»ãƒƒãƒˆï¼ˆç’°å¢ƒå¤‰æ•°ã‚’ä½¿ç”¨ã—ã¦bashè§£é‡ˆã‚’å›é¿ï¼‰
          body=$(jq -n --arg content "$DIFF_CONTENT" '{content: $content}')
          
          if [ $? -ne 0 ]; then
            echo "Error: Failed to create JSON payload" >&2
            exit 1
          fi

          # APIã‚³ãƒ¼ãƒ«å®Ÿè¡Œï¼ˆè©³ç´°ãªã‚¨ãƒ©ãƒ¼æƒ…å ±ã‚’å–å¾—ï¼‰
          http_code=$(curl -s -w "%{http_code}" -o /tmp/response.txt -X POST "$API_ENDPOINT" \
            -H "Content-Type: application/json" \
            -d "$body")
          
          curl_exit_code=$?
          
          # curlã®å®Ÿè¡Œçµæœã‚’æ¤œè¨¼
          if [ $curl_exit_code -ne 0 ]; then
            echo "Error: curl command failed with exit code $curl_exit_code" >&2
            echo "API Endpoint: $API_ENDPOINT" >&2
            case $curl_exit_code in
              2) echo "Details: curl failed to initialize or invalid parameters" >&2 ;;
              6) echo "Details: Could not resolve host" >&2 ;;
              7) echo "Details: Failed to connect to host" >&2 ;;
              28) echo "Details: Operation timeout" >&2 ;;
              *) echo "Details: Unknown curl error. Check network connectivity and API endpoint." >&2 ;;
            esac
            exit 1
          fi

          # HTTPã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚³ãƒ¼ãƒ‰ã‚’æ¤œè¨¼
          response=$(cat /tmp/response.txt)
          
          if [ "$http_code" -ge 200 ] && [ "$http_code" -lt 300 ]; then
            echo "API call successful (HTTP $http_code)"
          else
            echo "Warning: API returned HTTP status code $http_code" >&2
            echo "Response: $response" >&2
          fi

          # ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’ç’°å¢ƒå¤‰æ•°ã«ä¿å­˜ï¼ˆè¤‡æ•°è¡Œå¯¾å¿œï¼‰
          echo "response<<EOF" >> $GITHUB_OUTPUT
          echo "$response" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          
          echo "http_code<<EOF" >> $GITHUB_OUTPUT
          echo "$http_code" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Comment API response on PR
        uses: actions/github-script@v7
        with:
          script: |
            const response = ${{ toJson(steps.api-call.outputs.response) }};

            // ã‚³ãƒ¡ãƒ³ãƒˆæœ¬æ–‡ã‚’ä½œæˆ
            const commentBody = '## ğŸ¤– API Analysis Result\\n\\n```json\\n' + response + '\\n```\\n\\n---\\n\\n*Generated by GitHub Actions*';

            // PRã«ã‚³ãƒ¡ãƒ³ãƒˆã‚’æŠ•ç¨¿
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: commentBody
            });

  # ã™ã¹ã¦ã®ãƒ–ãƒ©ãƒ³ãƒã§ãƒ‡ãƒ—ãƒ­ã‚¤ã‚’è¨±å¯ï¼ˆPRæ™‚ã‚’é™¤ãï¼‰
  deploy:
    needs: pr-review
    if: always() && !contains(needs.*.result, 'failure') && !contains(needs.*.result, 'cancelled') && github.event_name != 'pull_request'
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
    env:
      AWS_IAM_ROLE_ARN: ${{ vars.AWS_IAM_ROLE_ARN }}
      AWS_REGION: "ap-northeast-1"
      AMPLIFY_APP_ID: ${{ vars.AMPLIFY_APP_ID }}
      AMPLIFY_ENV_NAME: "main"
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-region: ${{ env.AWS_REGION }}
          role-to-assume: ${{ env.AWS_IAM_ROLE_ARN }}
          
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'
          
      - name: Install dependencies
        run: npm ci
        
      - name: Build frontend
        run: npm run build
        
      - name: Create deployment and upload
        run: |
          echo "Creating frontend deployment job"
          RESPONSE=$(aws amplify create-deployment --branch-name ${{ env.AMPLIFY_ENV_NAME}} --app-id ${{ env.AMPLIFY_APP_ID }})
          JOB_ID=$(echo $RESPONSE | jq -r '.jobId')
          ZIP_URL=$(echo $RESPONSE | jq -r '.zipUploadUrl')
          
          echo "Zipping build artifacts"
          cd ./dist && zip -r ../build.zip * && cd ..
          
          echo "Uploading build.zip to Amplify"
          curl -X PUT -T "./build.zip" -H "Content-Type: application/zip" "$ZIP_URL"
          
          echo "Starting deployment job"
          aws amplify start-deployment --app-id ${{ env.AMPLIFY_APP_ID }} --branch-name ${{ env.AMPLIFY_ENV_NAME}} --job-id $JOB_ID
          
          echo "Deployment initiated successfully!"
